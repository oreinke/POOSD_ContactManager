<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h2 class="contact__title">Contact Manager</h2>
        <button class="btn btn-primary" onclick="doLogout()">Logout</button>
        
        <input type="text" id="search" class="form-control mt-3" placeholder="Search Contacts..." onkeyup="searchContacts()">
        
        <div class="mt-3">
            <input type="text" id="first_name" class="form-control mb-2" placeholder="First Name">
	    <input type="text" id="last_name" class="form-control mb-2" placeholder="Last Name">
            <input type="email" id="email" class="form-control mb-2" placeholder="Email">
            <button class="btn btn-success" onclick="addContact()">Add Contact</button>
        </div>
        
        <ul id="contact-list" class="list-group mt-3"></ul>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", fetchContacts);
        
        function fetchContacts() {
	    let payload = { search: "", userID: userID };
            fetch('API/SearchContacts.php')
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify(payload)
		})
                .then(response => response.json())
                .then(data => {
		   if(data.error && data.error.length > 0) 
		   {
		    console.error("Error fetching contacts:", data.error);
                    displayContacts ([]);
                   } else
		   {
		    display(data.results);
		   }
		})
                .catch(error => console.error("Error fetching contacts:", error));
        }

        function displayContacts(contacts) {
            let list = document.getElementById("contact-list");
            list.innerHTML = "";
            contacts.forEach(contact => {
                let li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";
				li.innerHTML = `${contact.first_name} ${contact.last_name} - ${contact.email} 
                    <button class='btn btn-danger btn-sm' onclick='deleteContact(${contact.id})'>Delete</button>`;
                list.appendChild(li);
            });
        }

        function searchContacts() {
            let query = document.getElementById("search").value.toLowerCase();
		let payload = {
		    search: query,    // the userâ€™s typed query
		    userId: userId    // must be the logged-in user's ID
		  };	    
            fetch('API/SearchContacts.php')
		method: 'POST',
    		headers: { 'Content-Type': 'application/json' },
    		body: JSON.stringify(payload)
 	 	})
                .then(response => response.json())
                .then(data => {
		    if (data.error && data.error.length > 0)
		    {
		     console.error("Search error:", data.error);
        	     // If the server says "No Records Found", you can show an empty list or a message
        	     displayContacts([]);
      		    }
      		    else
      		    {
                     displayContacts(filteredContacts);
		    }
                })
                .catch(error => console.error("Error searching contacts:", error));
        }

        function addContact() {
            let first_name = document.getElementById("first_name").value;
  	    let last_name  = document.getElementById("last_name").value; 
            let email = document.getElementById("email").value;
            
            fetch('API/AddContact.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ first_name, last_name, email })
            })
            .then(response => response.json())
            .then(() => {
                fetchContacts();
                document.getElementById("first_name").value = "";
      		document.getElementById("last_name").value  = ""; 
                document.getElementById("email").value = "";
            })
            .catch(error => console.error("Error adding contact:", error));
        }

        function deleteContact(id) {
            fetch(`API/DeleteContact.php?id=${id}`, { method: 'DELETE' })
                .then(() => fetchContacts())
                .catch(error => console.error("Error deleting contact:", error));
        }

        function logout() {
            fetch('API/Logout.php')
                .then(() => window.location.href = 'login.html')
                .catch(error => console.error("Error logging out:", error));
        }
    </script>
</body>
</html>
